## Outlier Detection

If we take a brief looking back, Kats trend detection and changepoint detection in both Kats and Greykite all return detected data points. Beside, any other data points that are worthy to explore?

One of an interesting concept is the outliers in time series. As you saw in [Queen Lotus][1], an outlier is an object that's quite diffrent from the rest of the data. In time series, such data point can be insightful, such as a data peak in fraud detection might tell us when there might be an abnormal event, or the skyrocketing online sales during COVID time can help us forecast customers' behavior in such events better, or we saw an extremely high data volume that's caused by a system error which had been fixed and won't happen again, etc., etc., there are many other fun examples.

Some of these outliers can be ignored, some should be take into consideration of model forecasting. Therefore, it's often a good practice to understand that causes of the outliers after the detection, then decide whether to remove the outliers.

In this section, you will not only see Kats and Greykite outlier detection, but also Lady H.'s self-implemented methods! ðŸ˜‰

### Kats Outlier Detection (Univariate Time Series)

Kats outlier detection for univariate time series is based on `n * IQR` idea, if a value is more than `n * IQR` away from Q1 (quantile 1) or Q3 (quantile 3), then this value will be considered as an outlier, you can adjust the value of `n`.

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/notes/iqr.png" width="766" height="79" />
</p>

More detailed process is, Kats will decompose the time series first using additive or multiplicative decomposition, its purpose is to remove trend, seasonality and only keep residuals, then it detects points in the residual which are outside `n * IQR`. By default, Kats uses `n=3` but you can adjust its value with parameter `iqr_mult`.

The detection code is as simple as the 2 lines of code below. The time series here is sales data which was proved to be a better fit for multiplication decomposition before, therefore here we are using "multiplication" as the decomposing method, set `iqr_mult` as 5 so that we can get more obvious outliers.

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/detection/kats_outlier_code.png" width="686" height="46" />
</p>

If we plot the detected outliers on the original timeseries data, it's more difficult to understand why they are the outliers, since the detected outliers are not all appear at crest or trough. However, after removing trend and seasonality effects, the detected data points on the residuals do appear to be more different from the rest of the data. 

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/detection/kats_outliers.png" width="1203" height="313" />
</p>

This also tells us, sometimes the crest or trough of a time series may not be an outlier even if they have the most extreme values, they might be caused by seasonality or trend.

At the same time, kats provides outlier removal function, and there are 2 options:
* No interpolation option will replace detected outliers with NAN
* With interpolation option will replace detected outliers using [linear interpolation][3] values

In the charts below, Lady H. has plotted the results from both options, the yellow line is the original time series while the green line is the time series after outlier detection and removal:

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/detection/kats_outlier_removal.png" width="1203" height="313" />
</p>

Again, we need to be cautious of outliers removal in time series data, since keeping some insightful data points will bring us more benefits than removing them.

ðŸŒ» [Check detailed code in Kats Outlier Detection >>][4]


### Lady H.'s Self Implemented Outlier Detection (Multivariate Time Series)

Although Kats provides multivariate time series detection, it simply didn't work. Check [this chat][2], you will see the errors Lady H. got in Kats multivariate outlier detection, you will also find the evidence that the problem was caused by the bug in Kats. After checking the basic logic of Kats multivariate outlier detection, Lady H. realized, it's more efficient to implement the method herself than debugging Kats. Besides, she implemented more solutions for multivariate time series outlier detection ðŸ˜‰



[1]:https://github.com/lady-h-world/My_Garden/blob/main/reading_pages/the_queen.md
[2]:https://github.com/facebookresearch/Kats/issues/194#event-6385149398
[3]:https://en.wikipedia.org/wiki/Interpolation#Linear_interpolation
[4]:https://github.com/lady-h-world/My_Garden/blob/main/code/yinyang/kats_experiments/kats_detect_outliers.ipynb
