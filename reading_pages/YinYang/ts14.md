# Time Series Model Forecasting

It is straightforward to apply deep learning or classical machine learning models on time series data. At the same time, there are models and tools designed for time series forecasting specifically, but online tutorials often only contain partial information or even misleading guidance, the promotion of promising tools is not common either. Therefore, Lady H. decided to show the super power from time series dedicated methods.

## Statistical Time Series Forecasting - (S)ARIMA

When it comes to time series forecasting, "ARIMA" is a popular method people often talk about, especially during data science interviews. But how many interviewees and even interviewers really used ARIMA in the work, and used well?

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/lady_heart_manga/arima_truth.png" width="971" height="384" />
</p>

Many online tutorials are misleading, either because they are missing important knowledge or contain more complex and unnecessary information. What's more, they always choose [Air Passenger data as an example][1], which is too simple to represent real world problems. One of the realities of time series forecasting is, same method applied to different datasets can lead to quite different model performance. 

So, Lady H. decided to show the ARIMA process she often applied that had been proved to be reliable on multiple time series problems. The data input will be our daily sales data:

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/data_exploration/daily_sales_plot.png" width="1092" height="293" />
</p>

### Step 1: Data Exploration

Before applying ARIMA, we can plot ACF and PACF of the data first.

* ACF: It is the autocorrelation plot. 
  * Autocorrelation reflects the degree of linear dependency between ith and (i+h)th (h is the lag) time series. Autocorrelation is a value between `[-1, 1]`. Positive autocorrelation means the two time series moves towards the same direction and negative means opposite directions, 0 autocorrelation means the temporal dependency is hard to find.
  * In ACF plot, each vertical bar indicates the autocorrelation between ith time series and (i+h)th time series. Given a confidence level (such as 95%), when the bar is out of the confidence interval (the threshold lines), the autocorrelation is significant.

* PACF: It is the partial autocorrelation plot. In ACF, the autocorrelation between ith time series and (i+h)th time series can be affected by (i+1)th, (i+2)th, ..., (i+h-1)th time series too, so PACF removes the influence from these intermediate values and only checks the autocorrelation between ith and (i+h)th time series.
  * Lag0 always has autocorrelation as 1.

Here're the ACF and PACF plots for our daily sales data:

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/forecasting/acf_pacf_sales.png" width="1093" height="266" />
</p>

ðŸŒ» [Check how to plot ACF & PACF >>][2]


### Step 2: Estimate ARIMA Parameters

The main reason of checking ACF and PACF plots is to help estimate the parameters of ARIMA. 
* `ARIMA(p, d, q)`
  * `p` is the order of AR (auto regression) model. AR model makes the prediction based on prior time values, therefore to decide p, we often check PACF to find which lag indicates significant partial auto correlation, and use that lag value as the value of `p`.
  * `q` is the order of MA (moving average) model. MA model uses the autocorrealtion between residuals to forecast values. We often check ACF to find the value of `q`.
  * `d` is the order of differencing needed to convert the time series to stationary.

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/notes/arima_stationary.png" width="766" height="79" />
</p>

* `SARIMA(p, d, q, m)` adds seasonality to ARIMA model
  * p, d, q has the same definition as ARIMA
  * `m` indicates the number of periods per season

Thumb rules for choose ARIMA parameter values:
* If ACF is exponentially decreasing or forming a sine-wave, and PACF has significant autocorrelation, then use p
* If ACF has significant autocorrelation and PACF has exponential decay or sine-wave pattern, then use q
* If both ACF, PACF are showing sine-waves, then use both p, q

Let's manually assign ARIMA parameters first. Although ACF and PACF are more complex than the thumb rules situations, we can start with using `p`. Meanwhile, when checking PACF, there are several lags showing significant autocorrelation. Lady H. tried `p` between 7 and 10 and found `p=10` got better AIC, BIC performance. The detail is shown as below:

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/forecasting/manually_arima_details.png" width="1193" height="948" />
</p>

1. Section 1 is showing the code of fitting ARIMA with manually chosen parameters
2. Section 2 is showing the training performance using AIC, BIC and HQIC
3. Section 3 explains why `p=10` got better performance than `p=7`, even though lag 7 is showing the highest autocorrelation, higher absolute coefficient and a lower standard error. Because when p is 7, only 7 lags' autocorrelation had been considered but when p is 10, there are a few more significant autocorrelated lags got considered. If you try `p=14` you might get even better performance.

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/notes/coefficient_arima.png" width="766" height="79" />
</p>

The comparision between forecatsed values and the real testing data is shown below, there is not much overlap between the green curve and the orange curve. We are using both MAPE (mean absolute percentage error) and R2 as the evaluation metrics, getting 4.46 MAPE and 0.1 R2, neither is a satisfying metric.

<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/Garden_Totem_images/forecasting/manually_arima_performance.png" width=994" height="378" />
</p>

ðŸŒ» [Check details of Manually Assigned ARIMA >>][2]

How can we improve the forecasting performance further? As we can see, applying the thumb rules can be tricky since the reality of the dataset can be more complex than expected. Often times, it's hard to decide ARIMA parameter values by only looking at PCF and PACF. A better solution is to decide the parameter values using HPO (hyperparameter tuning).

#
<p align="left">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/follow_us.png" width="120" height="50" />
</p>

[Keep going >>][3]

<p align="right">
<img src="https://github.com/lady-h-world/My_Garden/blob/main/images/going_back.png" width="60" height="44" />
</p>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<< Looking back][4]
 


[1]:https://rstudio-pubs-static.s3.amazonaws.com/223827_937f502e3e89492a95404356034ea1a7.html
[2]:https://github.com/lady-h-world/My_Garden/blob/main/code/yinyang/past_forecast_arima.ipynb
[3]:https://github.com/lady-h-world/My_Garden/blob/main/reading_pages/YinYang/ts15.md
[4]:https://github.com/lady-h-world/My_Garden/blob/main/reading_pages/YinYang/ts13.md
